<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth; // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ù…Ù†)

class AuthController extends Controller
{
    // ---------------------------------------------------
    // 1. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    // ÙˆØ¸ÙŠÙØªÙ‡Ø§: Ù…Ø¬Ø±Ø¯ ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ù€ Blade Ø§Ù„Ø°ÙŠ ØµÙ…Ù…ØªÙ‡
    // ---------------------------------------------------
    public function showLogin()
    {
        return view('auth.login');
    }

    // ---------------------------------------------------
    // 2. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø£Ù‡Ù…)
    // ÙˆØ¸ÙŠÙØªÙ‡Ø§: Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆØ§Ù„ØªØ­Ù‚Ù‚
    // ---------------------------------------------------
    public function login(Request $request)
    {
        // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ÙŠØ³Øª ÙØ§Ø±ØºØ©
        $request->validate([
            'university_id' => 'required', // Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ù„
            'national_id'   => 'required', // Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ù„
        ]);

        // Ø«Ø§Ù†ÙŠØ§Ù‹: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        // Ø§Ù†ØªØ¨Ù‡ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨ØªØ±ÙƒÙŠØ² ğŸ‘‡
        // Ø¯Ø§Ù„Ø© Auth::attempt ØªØªÙˆÙ‚Ø¹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­Ù‚Ù„ÙŠÙ†:
        // 1. Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙÙŠ Ø­Ø§Ù„ØªÙƒ Ù‡Ùˆ university_id)
        // 2. ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙÙŠ Ø­Ø§Ù„ØªÙƒ Ù‡ÙŠ national_id)
        // ÙˆÙ„ÙƒÙ† Ù„Ø§Ø±ÙÙŠÙ„ ÙŠÙÙ‡Ù… ÙƒÙ„Ù…Ø© "password" ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡Ø§Ø´ØŒ Ù„Ø°Ù„Ùƒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø®Ø¯Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:
        
        $credentials = [
            'university_id' => $request->university_id,
            'password'      => $request->national_id, // Ù†Ù…Ø±Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆÙƒØ£Ù†Ù‡ Ù‡Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
        ];

        // Ø«Ø§Ù„Ø«Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (Auth::attempt($credentials)) {
            // Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©)
            $request->session()->regenerate(); // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø£Ù…Ø§Ù† (Ù…Ù†Ø¹ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚)
            
            return redirect()->intended('dashboard'); // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        }

        // Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£)
        return back()->withErrors([
            'university_id' => 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
        ]);
    }

    // ---------------------------------------------------
    // 3. Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    // ---------------------------------------------------
    public function logout(Request $request)
    {
        Auth::logout(); // Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        $request->session()->invalidate(); // Ø­Ø±Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        $request->session()->regenerateToken(); // ØªØ£Ù…ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ
 
        return redirect('/login'); // Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    }
}